
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    // This function is the single source of truth for determining admin status.
    // It checks for the existence of a document in `roles_admin` where the
    // document ID matches the user's UID.
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // This function checks if the logged-in user's email matches the email
    // on a student document they are trying to access.
    function isStudentOwner(registerNumber) {
        // This 'get' is safe because it's only used in rules that are already
        // constrained to a specific student document (not a list).
        let studentDoc = get(/databases/$(database)/documents/students/$(registerNumber));
        return isSignedIn() && studentDoc.data.email == request.auth.email;
    }
    
    // This function checks if the logged-in user is a registered teacher.
    function isTeacher() {
        return isSignedIn() && exists(/databases/$(database)/documents/teachers/$(request.auth.email));
    }

    // This function retrieves the department for the currently authenticated teacher.
    function getTeacherDepartment() {
        return get(/databases/$(database)/documents/teachers/$(request.auth.email)).data.department;
    }
    
    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    // Manages administrator roles.
    match /roles_admin/{uid} {
      // A user can read their own role document to verify admin status.
      allow get: if request.auth.uid == uid;
      allow list: if false;
      // Only the user can create or modify their own role document.
      allow write: if request.auth.uid == uid;
    }

    // Manages student profile data.
    match /students/{registerNumber} {
      // Admins have full read and write access.
      allow read, write: if isAdmin();
      
      // A student can get their own profile. A teacher can get a student from their department.
      allow get: if (isSignedIn() && isStudentOwner(registerNumber)) || 
                   (isTeacher() && get(/databases/$(database)/documents/students/$(registerNumber)).data.department == getTeacherDepartment());
      
      // Teachers can list students only if they query by their own department.
      // Admins can list all students.
      allow list: if (isTeacher() && request.query.where.department == getTeacherDepartment()) || isAdmin();
    }

    // Manages teacher profile data.
    match /teachers/{teacherEmail} {
      // Admins have full read/write access.
      allow read, write: if isAdmin();
      // A teacher can read their own profile.
      allow get: if isSignedIn() && request.auth.email == teacherEmail;
      // Admins can list all teachers.
      allow list: if isAdmin();
    }

    // Manages student attendance records.
    match /attendance/{attendanceId} {
      // Admins have full read/write access.
      allow read, write: if isAdmin();
      
      // Students can list their own attendance via a constrained query.
      // Teachers can list attendance for their department via a constrained query.
      // Admins can list all records.
      allow list: if (isSignedIn() && request.query.where.studentRegister != null && isStudentOwner(request.query.where.studentRegister)) ||
                    (isTeacher() && request.query.where.department == getTeacherDepartment()) ||
                    isAdmin();
    }
    
    // Public information about the institution.
    match /institution/{docId} {
        allow get: if true;
        allow write: if isAdmin();
    }
  }
}
