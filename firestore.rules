rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ”‘ All logged-in users
    function isSignedIn() {
      return request.auth != null;
    }

    // ğŸ”‘ Admin (email-based)
    function isAdmin() {
      return request.auth != null
        && request.auth.token.email == "apdd46@gmail.com";
    }

    // --- Helper Functions ---
    function isTeacher() {
      return isSignedIn() && exists(/databases/$(database)/documents/teachers/$(request.auth.token.email));
    }

    function getTeacherDepartment() {
      return get(/databases/$(database)/documents/teachers/$(request.auth.token.email)).data.department;
    }
    
    // ğŸ¢ Institution Profile (publicly readable)
    match /institution/{profileId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ğŸ‘©â€ğŸ« Teachers collection (doc id = email)
    match /teachers/{email} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.token.email == email);
      allow write: if isAdmin();
    }

    // ğŸ“ Students collection (email is a field, not doc id)
    match /students/{studentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // â° Attendance Records
    match /attendance/{attendanceId} {
      // Admins get full access
      allow read, write: if isAdmin();

      // Teachers can read records from their department and create records for their department
      allow list: if isTeacher() && request.query.where.department == getTeacherDepartment();
      allow get: if isTeacher() && get(/databases/$(database)/documents/attendance/$(attendanceId)).data.department == getTeacherDepartment();
      allow write: if isTeacher() && request.resource.data.department == getTeacherDepartment();

      // Students can only read their own records
      allow list: if isSignedIn() && request.query.where.studentRegister != null && get(/databases/$(database)/documents/students/$(request.query.where.studentRegister)).data.email == request.auth.token.email;
      allow get: if isSignedIn() && get(/databases/$(database)/documents/attendance/$(attendanceId)).data.studentRegister != null && get(/databases/$(database)/documents/students/$(get(/databases/$(database)/documents/attendance/$(attendanceId)).data.studentRegister)).data.email == request.auth.token.email;
    }

    // ğŸ”’ Deny everything else not explicitly allowed
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
